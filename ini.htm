<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<head>
	<meta charset="UTF-8" />
	<!-- <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="css/jquery.mobile-1.0.1.min.css" />
	<!-- <script type="text/javascript" src="cordova.js"></script> -->
	<script type="text/javascript" src="js/mc.js"></script>

	<script src="js/jquery.js"></script>
	<script src="js/jquery.mobile-1.4.5.min.js"></script>
</head>

<body>

	<script type="text/javascript">

		window.onerror = function (message, url, lineNumber) {
			alert(`Error: ${message} in ${url} at line ${lineNumber}`);
		}

		document.addEventListener("deviceready", onDeviceReady, false);

		function onDeviceReady() {
			iniciar();
		}

		/////////////////////////////
		function iniciar() {
			window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
			window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
			window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

			if (!window.indexedDB) {
				alert("Seu navegador não suporta uma versão estável do IndexedDB. Alguns recursos não estarão disponíveis.");
			}

			var db;
			// Abrindo o banco de dados
			var request = window.indexedDB.open("sigmaDB", 1.0);

			request.onerror = function (event) {
				alert("Erro ao criar o banco!");
			}

			request.onsuccess = function (event) {
				db = request.result;
				db.onerror = function () {
					// Função genérica para tratar os erros de todos os requests desse banco!
					alert("Database error: " + event.target.errorCode);
				}
			}

			var dados_cliente = [
				{ id_cliente: "1", nome_empree: "green design", e_construtora: "0" },
				{ id_cliente: "2", nome_empree: "sigma", e_construtora: "1" },
				{ id_cliente: "3", nome_empree: "sigma", e_construtora: "0" },
			];

			request.onupgradeneeded = function(event) {
				db = event.target.result;

				// cria um objectStore para esse banco
				var objectStore = db.createObjectStore("mtab_cliente", { keyPath: "id_cliente" });

				objectStore.createIndex("id_cliente", "id_cliente", { unique: true });
				objectStore.createIndex("nome_empree", "nome_empree", { unique: false });
				objectStore.createIndex("e_construtora", "e_construtora", { unique: false });
				
				objectStore.createIndex("nome_empree2", ["nome_empree", "id_cliente"], { unique: false });

				objectStore.transaction.oncomplete = function(event) {
					var transaction = db.transaction(["mtab_cliente"], "readwrite");
					
					transaction.oncomplete = function(event) {
						alert("Pronto!");
					}

					transaction.onerror = function(event) {
						alert("Ocorreu um erro!");
					}

					var objectStore = transaction.objectStore("mtab_cliente");
					for(var i in dados_cliente) {
						var request = objectStore.add(dados_cliente[i]);
						request.onsuccess = function(event) {
							alert("inserção realizada: " + event.target.result);
						}
					}

					// var lowerBound = ['sigma'];
					// var upperBound = ['green design'];
					// var range = IDBKeyRange.bound(lowerBound, upperBound, false, true);
					// alert(range);

					var whereEquals = IDBKeyRange.only(["sigma", "3"]);

					var request1 = db.transaction(["mtab_cliente"], "readwrite").objectStore("mtab_cliente").index("e_construtora");
					var request = request1.get("0");

					request.onerror = function(event) {
						alert("falhou!");
					}
					request.onsuccess = function(event) {
						var data = request.result;

						data.nome_empree = "sigmacivil 2.0";

						// Atulizar esse dado no banco
						var requestUpdate = request1.put(data);
						requestUpdate.onerror = function(event) {
							alert("falhou!");
						};
						requestUpdate.onsuccess = function(event) {
							alert(request.result.nome_empree);
						};
					}
				}
			}
		}

		iniciar()

	</script>

</body>

</html>