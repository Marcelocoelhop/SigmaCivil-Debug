<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<head>
	<!-- <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> -->
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" />
	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript" src="js/mc.js" />
	</script>

	<script src="js/jquery.js"></script>
	<script src="js/jquery.mobile-1.4.5.min.js"></script>

</head>

<body>

	<script type="text/javascript">

		var login = getquerystring("login");
		var senha = getquerystring("senha");

		var num_empree;
		var logou;


		document.addEventListener("deviceready", onDeviceReady, false);

		function onDeviceReady() {

			if (navigator.connection.type == 0 || navigator.connection.type == 'none') {
				alert('Sem conexão com internet. Favor se conectar.');
				window.location.assign("ini.htm");
			}
			else {
				iniciar();
			}

		}

		// setTimeout(() => {
		// 	try {
		// 		iniciar()
		// 	} catch(err) {
		// 		window.location.assign("login.htm")
		// 	}
		// }, 3000)

		/////////////////////////////
		function iniciar() {
			window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
			window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
			window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

			if (!window.indexedDB) {
				alert("Seu navegador não suporta uma versão estável do IndexedDB. Alguns recursos não estarão disponíveis.");
			}

			var ajax = new XMLHttpRequest();
			ajax.open("GET", "https://www.sigmacivil.com.br/app_sc/consult_emp.asp?l=" + login + "&s=" + senha + "&versao=2.0&t=" + Math.random(), true);
			ajax.onreadystatechange = function () {
				if (ajax.readyState == 4) {//Request complete !!
					if (ajax.status == 200 || ajax.status == 0) { // OK response

						var resposta_total = ajax.responseText;
						var jsontext = resposta_total.split("*")

						var getLogin = JSON.parse(jsontext[0]);
						logou = getLogin.logou;
						qual_id_cliente = getLogin.id_cliente;
						num_empree = getLogin.id_empree;
						nome_empree = getLogin.nome_empree;
						q_e_construtora = getLogin.e_construtora;
						data_implantacao_sc = getLogin.data_implantacao_sc;
						status_sync = getLogin.status_sync;


						if (logou == "S") {

							var getEmpree = jsontext[1];
							var objEmpree = JSON.parse(getEmpree);

							alert("objEmpree.dados_empreendimento.length: " + objEmpree.dados_empreendimento.length)

							var db;
							var request = window.indexedDB.open("db_sigmacivil", "1");

							request.onerror = function (event) {
								alert("Erro ao criar o banco");
							};


							var clientes = [
								{
									id_cliente: qual_id_cliente,
									e_construtora: q_e_construtora,
									text1: login,
									text2: senha
								}
							];

							var emprees = [
								{
									id_empree: num_empree,
									nome_empree: nome_empree,
									status_sync: status_sync,
									data_implantacao_sc: data_implantacao_sc
								},
							];

							for (i = 0; i < objEmpree.dados_empreendimento.length; i++) {
								var manuts = [
									{
										id_prog_manut: objEmpree.dados_empreendimento[i].id_prog_manut,
										nome_sistema: objEmpree.dados_empreendimento[i].nome_sistema,
										nome_atividade: objEmpree.dados_empreendimento[i].nome_atividade,
										nome_periodicidade: objEmpree.dados_empreendimento[i].nome_periodicidade,
										qtde_agrupamentos_eventos: objEmpree.dados_empreendimento[i].qtde_agrupamentos_eventos,
										qtde_dias_periodicidade: objEmpree.dados_empreendimento[i].qtde_dias_periodicidade,
										data_inicial_garantia: objEmpree.dados_empreendimento[i].data_inicial_garantia,
										prazo_garantia_dias: objEmpree.dados_empreendimento[i].prazo_garantia_dias,
										formato_periodicidade: objEmpree.dados_empreendimento[i].formato_periodicidade
									}
								];

								//alert(manuts[i])
							}

							request.onsuccess = function (event) {
								db = request.result;

								removerDados(db, 'mtab_cliente');
								addCliente(db, clientes);

								removerDados(db, 'mtab_empree');
								addEmpree(db, emprees);

								removerDados(db, 'mtab_prog_manut');
								addManut(db, manuts);

								removerDados(db, 'mtab_prog_manut_evento');
								go_to();

								db.onerror = function (event) {
									alert("Database error: " + event.target.error);
								}
							};

							// request.onupgradeneeded = function (event) {
							// 	db = event.target.result;
							// 	var mtab_cliente = db.createObjectStore("mtab_cliente", { keyPath: "id_cliente" });

							// 	mtab_cliente.createIndex("id_cliente", "id_cliente", { unique: true });
							// 	mtab_cliente.createIndex("e_construtora", "e_construtora", { unique: false });
							// 	mtab_cliente.createIndex("text1", "text1", { unique: false });
							// 	mtab_cliente.createIndex("text2", "text2", { unique: false });

							// 	var mtab_empree = db.createObjectStore("mtab_empree", { keyPath: "id_empree" });

							// 	mtab_empree.createIndex("id_empree", "id_empree", { unique: true });
							// 	mtab_empree.createIndex("nome_empree", "nome_empree", { unique: false });
							// 	mtab_empree.createIndex("status_sync", "status_sync", { unique: false });
							// 	mtab_empree.createIndex("data_implantacao_sc", "data_implantacao_sc", { unique: false });

							// 	var mtab_prog_manut = db.createObjectStore("mtab_prog_manut", { keyPath: "id_prog_manut" });

							// 	mtab_prog_manut.createIndex("id_prog_manut", "id_prog_manut", { unique: true });
							// 	mtab_prog_manut.createIndex("nome_sistema", "nome_sistema", { unique: false });
							// 	mtab_prog_manut.createIndex("nome_atividade", "nome_atividade", { unique: false });
							// 	mtab_prog_manut.createIndex("nome_periodicidade", "nome_periodicidade", { unique: false });
							// 	mtab_prog_manut.createIndex("qtde_agrupamentos_eventos", "qtde_agrupamentos_eventos", { unique: false });
							// 	mtab_prog_manut.createIndex("qtde_dias_periodicidade", "qtde_dias_periodicidade", { unique: false });
							// 	mtab_prog_manut.createIndex("data_inicial_garantia", "data_inicial_garantia", { unique: false });
							// 	mtab_prog_manut.createIndex("prazo_garantia_dias", "prazo_garantia_dias", { unique: false });
							// 	mtab_prog_manut.createIndex("formato_periodicidade", "formato_periodicidade", { unique: false });

							// 	var mtab_prog_manut_evento = db.createObjectStore("mtab_prog_manut_evento", { keyPath: "id_prog_manut" });

							// 	mtab_prog_manut_evento.createIndex("id_prog_manut", "id_prog_manut", { unique: true });
							// 	mtab_prog_manut_evento.createIndex("dia_evento", "dia_evento", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("mes_evento", "mes_evento", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("ano_evento", "ano_evento", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("caminho_imagens", "caminho_imagens", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("caminho_audio", "caminho_audio", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("caminho_video", "caminho_video", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("caminho_texto", "caminho_texto", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("status_imagens_upl", "status_imagens_upl", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("status_video_upl", "status_video_upl", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("status_audio_upl", "status_audio_upl", { unique: false });
							// 	mtab_prog_manut_evento.createIndex("status_texto_upl", "status_texto_upl", { unique: false });
							// };

							// request.onsuccess = function (event) {
							// 	db = event.target.result;

							// 	removerDados(db, 'mtab_cliente');
							// 	addCliente(db, clientes);

							// 	removerDados(db, 'mtab_empree');
							// 	addEmpree(db, emprees);

							// 	removerDados(db, 'mtab_prog_manut');
							// 	addManut(db, manuts);

							// 	removerDados(db, 'mtab_prog_manut_evento');
							// 	go_to();
							// 	// consultaCliente(db, clientes, emprees);
							// }

							// request.onerror = function (event) {
							// 	alert("Erro na criação: " + event.target.error);
							// }


							// alert(manuts.nome_sistema)

							function addCliente(db, clientes) {
								var tx = db.transaction(['mtab_cliente'], 'readwrite');
								var store = tx.objectStore('mtab_cliente');

								for (var i in clientes) {
									store.add(clientes[i]);
								}

								// clientes.map(function (cliente) {
								// 	store.add(cliente);
								// });

								tx.oncomplete = function () {
									alert('stored note!')
								}

								tx.onerror = function (event) {
									alert('error storing note ' + event.target.error);
								}
							}

							function addEmpree(db, emprees) {
								var tx = db.transaction(['mtab_empree'], 'readwrite');
								var store = tx.objectStore('mtab_empree');

								for (var i in emprees) {
									store.add(emprees[i]);
								}

								// emprees.map(function (empree) {
								// 	store.add(empree);
								// });

								tx.oncomplete = function () {
									alert('stored note empree!')
								}

								tx.onerror = function (event) {
									alert('error storing empree note ' + event.target.error);
								}
							}

							function addManut(db, manuts) {
								var tx = db.transaction(['mtab_prog_manut'], 'readwrite');
								var store = tx.objectStore('mtab_prog_manut');

								for (var i in manuts) {
									store.add(manuts[i]);
								}

								// store.add(manuts)

								// manuts.map(function (manut) {
								// 	alert(manut.nome_sistema)
								// 	store.add(manut);
								// });

								tx.oncomplete = function () {
									alert('stored note manut!')
								}

								tx.onerror = function (event) {
									alert('error storing manut note ' + event.target.error);
								}
							}

							function removerDados(db, tabela) {
								var tx = db.transaction([tabela], 'readwrite');
								var store = tx.objectStore(tabela);

								var objectStoreRequest = store.clear();
								objectStoreRequest.onsuccess = function (event) {
									alert("dados apagados");
								}
							}

							// var db = window.openDatabase("DB_SigmaCivil", "1.0", "DB_SigmaCivil", 200000); //will create database Dummy_DB or open it

							// ///////////////  tabela cliente //////////////
							// db.transaction(function (tx) {
							// 	tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_cliente (id_cliente INTEGER, e_construtora TEXT,text1 TEXT, text2 TEXT)');
							// 	tx.executeSql('Delete FROM mtab_cliente');
							// 	tx.executeSql('INSERT INTO mtab_cliente(id_cliente,e_construtora,text1,text2) VALUES (?,?,?,?)', [qual_id_cliente, q_e_construtora, login, senha]);

							// 	/////////////// fim  tabela cliente //////////////

							// 	///////////////  tabela empree //////////////
							// 	tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_empree (id_empree INTEGER, nome_empree TEXT, status_sync TEXT, data_implantacao_sc TEXT)');
							// 	tx.executeSql('Delete FROM mtab_empree');
							// 	tx.executeSql('INSERT INTO mtab_empree(id_empree,nome_empree,status_sync,data_implantacao_sc) VALUES (?,?,?,?)', [num_empree, nome_empree, status_sync, data_implantacao_sc]);
							// 	/////////////// fim  tabela empree //////////////

							// 	///////////////  tabela programa_manutenção //////////////
							// 	tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_prog_manut (id_prog_manut INTEGER, nome_sistema TEXT,nome_atividade TEXT, nome_periodicidade TEXT, qtde_agrupamentos_eventos INTEGER, qtde_dias_periodicidade INTEGER, data_inicial_garantia TEXT, prazo_garantia_dias INTEGER, formato_periodicidade TEXT)');
							// 	tx.executeSql('Delete FROM mtab_prog_manut');
							// 	for (i = 0; i < objEmpree.dados_empreendimento.length; i++) {
							// 		tx.executeSql('INSERT INTO mtab_prog_manut(id_prog_manut,nome_sistema,nome_atividade,nome_periodicidade,qtde_agrupamentos_eventos,qtde_dias_periodicidade,data_inicial_garantia,prazo_garantia_dias,formato_periodicidade) VALUES (?,?,?,?,?,?,?,?,?)', [objEmpree.dados_empreendimento[i].id_prog_manut, objEmpree.dados_empreendimento[i].nome_sistema, objEmpree.dados_empreendimento[i].nome_atividade, objEmpree.dados_empreendimento[i].nome_periodicidade, objEmpree.dados_empreendimento[i].qtde_agrupamentos_eventos, objEmpree.dados_empreendimento[i].qtde_dias_periodicidade, objEmpree.dados_empreendimento[i].data_inicial_garantia, objEmpree.dados_empreendimento[i].prazo_garantia_dias, objEmpree.dados_empreendimento[i].formato_periodicidade]);
							// 	}

							// 	///////////////  tabela programa_manutenção + evento //////////////
							// 	tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_prog_manut_evento (id_prog_manut INTEGER, dia_evento TEXT, mes_evento TEXT, ano_evento TEXT, caminho_imagens TEXT, caminho_audio TEXT, caminho_video TEXT, caminho_texto TEXT, status_imagens_upl TEXT, status_video_upl TEXT , status_audio_upl TEXT, status_texto_upl TEXT)');
							// 	tx.executeSql('Delete FROM mtab_prog_manut_evento');

							// 	go_to()

							// });
							///////////////  FIM tabela programa_manutenção //////////////	  

						}

						else {  //nao logou
							window.location.assign("login.htm");
						}

					}
					else {
						alert("Problemas com sua conexao internet. Erro: 0145");
					}
				}
			}
			ajax.send();
		}

		function tem_conexao() {

			if (navigator.connection.type == 0 || navigator.connection.type == 'none') {
				// alert('Sem conexão com internet. Favor se conectar.');
				return false;
			}
			else {
				return true;
			}

		}

		function go_to() {
			if (tem_conexao()) {
				window.location.assign("empree_online.htm?e=" + num_empree + "&l=" + login + "&s=" + senha)
			} else {
				window.location.assign("empree.htm?e=" + num_empree + "&l=" + login + "&s=" + senha);
			}
		}

	</script>

</body>

</html>