<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<head>
    <meta charset="UTF-8" />
    <!-- <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/jquery.mobile-1.0.1.min.css" />
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/mc.js" />
    </script>

    <script src="js/jquery.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
</head>

<body>

    <script type="text/javascript">

        window.onerror = function (message, url, lineNumber) {
            //alert("Error: " + message + " in " + url + " at line " + lineNumber);
            alert(`Error: ${message} in ${url} at line ${lineNumber}`);
        }

        document.addEventListener("deviceready", onDeviceReady, false);

        function onDeviceReady() {
            iniciar();
        }

        /////////////////////////////
        function iniciar() {
            window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
            window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
            window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

            if (!window.indexedDB) {
                alert("Seu navegador não suporta uma versão estável do IndexedDB. Alguns recursos não estarão disponíveis.");
            }

            var db;
            var request = window.indexedDB.open("db_sigmacivil", "1");

            request.onerror = function (event) {
                alert("Erro ao criar o banco");
            };

            request.onsuccess = function (event) {
                db = request.result;

                alert("ponto banco aberto")
                consultaCliente(db, clientes, emprees);

                db.onerror = function (event) {
                    alert("Database error: " + event.target.error);
                }
            };

            request.onupgradeneeded = function (event) {
                alert("ponto onupgradeneeded")
                db = event.target.result;

                var mtab_cliente = db.createObjectStore("mtab_cliente", { keyPath: "id_cliente" });

                mtab_cliente.createIndex("id_cliente", "id_cliente", { unique: true });
                mtab_cliente.createIndex("e_construtora", "e_construtora", { unique: false });
                mtab_cliente.createIndex("text1", "text1", { unique: false });
                mtab_cliente.createIndex("text2", "text2", { unique: false });

                var mtab_empree = db.createObjectStore("mtab_empree", { keyPath: "id_empree" });

                mtab_empree.createIndex("id_empree", "id_empree", { unique: true });
                mtab_empree.createIndex("nome_empree", "nome_empree", { unique: false });
                mtab_empree.createIndex("status_sync", "status_sync", { unique: false });
                mtab_empree.createIndex("data_implantacao_sc", "data_implantacao_sc", { unique: false });

                var mtab_prog_manut = db.createObjectStore("mtab_prog_manut", { keyPath: "id_prog_manut" });

                mtab_prog_manut.createIndex("id_prog_manut", "id_prog_manut", { unique: true });
                mtab_prog_manut.createIndex("nome_sistema", "nome_sistema", { unique: false });
                mtab_prog_manut.createIndex("nome_atividade", "nome_atividade", { unique: false });
                mtab_prog_manut.createIndex("nome_periodicidade", "nome_periodicidade", { unique: false });
                mtab_prog_manut.createIndex("qtde_agrupamentos_eventos", "qtde_agrupamentos_eventos", { unique: false });
                mtab_prog_manut.createIndex("qtde_dias_periodicidade", "qtde_dias_periodicidade", { unique: false });
                mtab_prog_manut.createIndex("data_inicial_garantia", "data_inicial_garantia", { unique: false });
                mtab_prog_manut.createIndex("prazo_garantia_dias", "prazo_garantia_dias", { unique: false });
                mtab_prog_manut.createIndex("formato_periodicidade", "formato_periodicidade", { unique: false });
                mtab_prog_manut.createIndex("comparar_prog_manut", ["id_prog_manut"], { unique: false });

                var mtab_prog_manut_evento = db.createObjectStore("mtab_prog_manut_evento", { keyPath: "id_prog_manut" });

                mtab_prog_manut_evento.createIndex("id_prog_manut", "id_prog_manut", { unique: true });
                mtab_prog_manut_evento.createIndex("dia_evento", "dia_evento", { unique: false });
                mtab_prog_manut_evento.createIndex("mes_evento", "mes_evento", { unique: false });
                mtab_prog_manut_evento.createIndex("ano_evento", "ano_evento", { unique: false });
                mtab_prog_manut_evento.createIndex("caminho_imagens", "caminho_imagens", { unique: false });
                mtab_prog_manut_evento.createIndex("caminho_audio", "caminho_audio", { unique: false });
                mtab_prog_manut_evento.createIndex("caminho_video", "caminho_video", { unique: false });
                mtab_prog_manut_evento.createIndex("caminho_texto", "caminho_texto", { unique: false });
                mtab_prog_manut_evento.createIndex("status_imagens_upl", "status_imagens_upl", { unique: false });
                mtab_prog_manut_evento.createIndex("status_video_upl", "status_video_upl", { unique: false });
                mtab_prog_manut_evento.createIndex("status_audio_upl", "status_audio_upl", { unique: false });
                mtab_prog_manut_evento.createIndex("status_texto_upl", "status_texto_upl", { unique: false });
                mtab_prog_manut_evento.createIndex("comparar", ["id_prog_manut", "dia_evento", "mes_evento", "ano_evento"], { unique: false });
            };

            // request.onsuccess = function (event) {
            //     alert('ponto sucesso 2');
            //     db = event.target.result;
            //     // addCliente(db, clientes);
            //     // addEmpree(db, emprees);
            //     //consultaCliente(db, clientes, emprees);
            // }

            request.onerror = function (event) {
                alert("Erro na criação: " + event.target.error);
            }

            var clientes = [];

            var emprees = [];

            function consultaCliente(db, clientes, emprees) {
                var login = "";
                var senha = "";
                var tx = db.transaction(['mtab_cliente'], 'readwrite');
                var store = tx.objectStore('mtab_cliente');
                var objectStoreRequest = store.openCursor();
                objectStoreRequest.onsuccess = function (event) {
                    var cursor = event.target.result;
                    if (cursor) {
                        clientes.push(cursor.value);

                        login = cursor.value.text1;
                        alert(login)
                        senha = cursor.value.text2;

                        //cursor.continue();
                    }
                    else {
                        alert("sem cursor")
                    }
                }

                var tx2 = db.transaction(['mtab_empree'], 'readwrite');
                var store2 = tx2.objectStore('mtab_empree');
                var objectStoreRequest2 = store2.openCursor();
                objectStoreRequest2.onsuccess = function (event) {


                    alert('ponto 1');
                    var cursor = event.target.result;
                    if (cursor) {
                        emprees.push(cursor.value);

                        var id_empree = cursor.value.id_empree;

                        alert(clientes.length);
                        alert(emprees.length);

                        if (clientes.length > 0 && emprees.length > 0) {

                            cliente_existe("?e=" + id_empree + "&l=" + login + "&s=" + senha);

                        }

                    } else {
                        cliente_nao_existe();
                    }

                }
            }

            // var DBDeleteRequest = window.indexedDB.deleteDatabase("db_sigmacivil");

            // DBDeleteRequest.onerror = function (event) {
            //     alert("Error deleting database.");
            // };

            // DBDeleteRequest.onsuccess = function (event) {
            //     alert("Database deleted successfully");

            //     alert(event.result); // should be undefined
            // };


            // var db = window.openDatabase("DB_SigmaCivil", "1.0", "DB_SigmaCivil", 200000); //will create database Dummy_DB or open it

            ///////////////  tabela cliente //////////////
            // db.transaction(function (tx) {
            //     tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_cliente (id_cliente INTEGER, e_construtora TEXT, text1 TEXT, text2 TEXT)');
            //     tx.executeSql('SELECT * FROM mtab_cliente', [], function (tx, results) {
            //         var len1 = results.rows.length;
            //         alert(len1)

            //         var j;
            //         for (j = 0; j < len1; j++) {
            //             var row = results.rows.item(j);
            //             var login = row['text1'];
            //             alert("login: " + login)
            //             var senha = row['text2'];
            //         }

            //         tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_empree (id_empree INTEGER, nome_empree TEXT, status_sync TEXT, data_implantacao_sc TEXT)');
            //         tx.executeSql('SELECT * FROM mtab_empree', [], function (tx, results) {
            //             var len2 = results.rows.length;     //verifica se tem algum comprador (evitar o caso de nao ter escolhido empreendimento e saido antes)

            //             if (len1 > 0 && len2 > 0) {
            //                 ///////////////  FIM tabela empreendimento //////////////	        
            //                 db.transaction(function (tx) {
            //                     tx.executeSql('SELECT * FROM mtab_empree', [], function (tx, results) {
            //                         var len = results.rows.length;
            //                         var i;
            //                         for (i = 0; i < len; i++) {
            //                             var row = results.rows.item(i)
            //                             var id_empree = row['id_empree'];
            //                         }
            //                         cliente_existe("?e=" + id_empree + "&l=" + login + "&s=" + senha);
            //                     }, null);
            //                 });
            //                 ///////////////  FIM tabela empreendimento //////////////	        
            //             }
            //             else {
            //                 cliente_nao_existe();
            //             }

            //         }, null);

            //     }, null);

            // });

        }

        function tem_conexao() {

            if (navigator.connection.type == 0 || navigator.connection.type == 'none') {
                // alert('Sem conexão com internet. Favor se conectar.');
                return false;
            }
            else {
                return true;
            }

        }

        function cliente_nao_existe() {

            window.location.assign("login.htm");
        }

        function cliente_existe(parametro1) {

            if (tem_conexao()) {

                window.location.assign("empree_online.htm" + parametro1)
            } else {

                window.location.assign("empree.htm" + parametro1);
            }
        }

    </script>

</body>

</html>