<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<head>
	<meta charset="UTF-8" />
	<!-- <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="css/jquery.mobile-1.0.1.min.css" />
	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript" src="js/mc.js" />
	</script>

	<script src="js/jquery.js"></script>
	<script src="js/jquery.mobile-1.4.5.min.js"></script>
</head>

<body>

	<script type="text/javascript">

		window.onerror = function (message, url, lineNumber) {
			//alert("Error: " + message + " in " + url + " at line " + lineNumber);
			alert(`Error: ${message} in ${url} at line ${lineNumber}`);
		}

		document.addEventListener("deviceready", onDeviceReady, false);

		function onDeviceReady() {

			iniciar();
		}

		/////////////////////////////
		function iniciar() {
			// window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
			// window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
			// window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

			// if (!window.indexedDB) {
			// 	alert("Seu navegador não suporta uma versão estável do IndexedDB. Alguns recursos não estarão disponíveis.");
			// }

			var db = window.openDatabase("DB_SigmaCivil", "1.0", "DB_SigmaCivil", 200000); //will create database Dummy_DB or open it

			// var db;
			// var request = window.indexedDB.open("DB_SigmaCivil", "1.0");

			// request.onerror = function (event) {
			// 	alert("Erro ao criar o banco");
			// };

			// request.onsuccess = function (event) {
			// 	db = request.result;
			// 	db.onerror = function (event) {
			// 		alert("Database error: " + event.target.errorCode);
			// 	}
			// }

			// var len1 = [];

			// request.onupgradeneeded = function (event) {
			// 	db = event.target.result;

			// 	var objectStore = db.createObjectStore("mtab_cliente", { keyPath: "id_cliente" });

			// 	objectStore.createIndex("id_cliente", "id_cliente", { unique: true });
			// 	objectStore.createIndex("e_construtora", "e_construtora", { unique: false });
			// 	objectStore.createIndex("text1", "text1", { unique: false });
			// 	objectStore.createIndex("text2", "text2", { unique: false });

			// 	objectStore.transaction.oncomplete = function (event) {
			// 		var transaction = db.transaction(["mtab_cliente"], "readwrite");

			// 		transaction.oncomplete = function (event) {
			// 			alert("Pronto!");
			// 		};

			// 		transaction.onerror = function (event) {
			// 			alert("Ocorreu um erro!");
			// 		}

			// 		var objectStore = transaction.objectStore("mtab_cliente");
			// 		for (var i in len1) {
			// 			var request = objectStore.add(len1[i]);
			// 			request.onsuccess = function (event) {
			// 				alert("inserção realizada: " + event.target.result);
			// 			}
			// 		}

			// 		var objectStoreRequest = objectStore.openCursor();
			// 		objectStoreRequest.onsuccess = function (event) {
			// 			var cursor = event.target.result;
			// 			if (cursor) {
			// 				len1.push(cursor.value);
			// 				cursor.continue();
			// 			} else {

			// 			}
			// 		}
			// 	}
			// };

			///////////////  tabela cliente //////////////
			db.transaction(function (tx) {
				tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_cliente (id_cliente INTEGER, e_construtora TEXT, text1 TEXT, text2 TEXT)');
				tx.executeSql('SELECT * FROM mtab_cliente', [], function (tx, results) {
					var len1 = results.rows.length;
					alert(len1)

					var j;
					for (j = 0; j < len1; j++) {
						var row = results.rows.item(j);
						var login = row['text1'];
						alert("login: " + login)
						var senha = row['text2'];
					}

					tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_empree (id_empree INTEGER, nome_empree TEXT, status_sync TEXT, data_implantacao_sc TEXT)');
					tx.executeSql('SELECT * FROM mtab_empree', [], function (tx, results) {
						var len2 = results.rows.length;     //verifica se tem algum comprador (evitar o caso de nao ter escolhido empreendimento e saido antes)

						if (len1 > 0 && len2 > 0) {
							///////////////  FIM tabela empreendimento //////////////	        
							db.transaction(function (tx) {
								tx.executeSql('SELECT * FROM mtab_empree', [], function (tx, results) {
									var len = results.rows.length;
									var i;
									for (i = 0; i < len; i++) {
										var row = results.rows.item(i)
										var id_empree = row['id_empree'];
									}
									cliente_existe("?e=" + id_empree + "&l=" + login + "&s=" + senha);
								}, null);
							});
							///////////////  FIM tabela empreendimento //////////////	        
						}
						else {
							cliente_nao_existe();
						}

					}, null);

				}, null);

			});

		}

		function tem_conexao() {

			if (navigator.connection.type == 0 || navigator.connection.type == 'none') {
				// alert('Sem conexão com internet. Favor se conectar.');
				return false;
			}
			else {
				return true;
			}

		}

		function cliente_nao_existe() {

			window.location.assign("login.htm");
		}

		function cliente_existe(parametro1) {

			if (tem_conexao()) {

				window.location.assign("empree_online.htm" + parametro1)
			} else {

				window.location.assign("empree.htm" + parametro1);
			}
		}

	</script>

</body>

</html>